C251 COMPILER V5.60.0,  lsm303                                                             06/04/24  15:24:48  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE lsm303
OBJECT MODULE PLACED IN .\Objects\lsm303.obj
COMPILER INVOKED BY: C:\Keil_v5\C251\BIN\C251.EXE Externals\lsm303.c XSMALL INTR2 BROWSE INCDIR(.\Internals;.\Externals)
                    - DEBUG PRINT(.\Listings\lsm303.lst) TABS(2) OBJECT(.\Objects\lsm303.obj) 

stmt  level    source

    1          #include "lsm303.h"
    2          
    3          void LSM303_MasterWriteOneBytetoSlave(unsigned char slave_addr, unsigned char register_addr, unsigned cha
             -r dat_to_send) 
    4          {
    5   1          // MASTER   Start   SlaveAddr+W             RegisterAddr            Data            Stop
    6   1          // SLAVE                            ACK                     ACK             ACK
    7   1          IIC_START();
    8   1          IIC_SENDBYTE(slave_addr+0);
    9   1          IIC_WAITACK();
   10   1          IIC_SENDBYTE(register_addr);
   11   1          IIC_WAITACK();
   12   1          IIC_SENDBYTE(dat_to_send);
   13   1          IIC_WAITACK();
   14   1          IIC_STOP();
   15   1      }
   16          
   17          void LSM303_MasterWriteMultipleBytestoSlave(unsigned char slave_addr, unsigned char register_addr, unsign
             -ed char *dat_to_send, unsigned char bytes_to_send)
   18          {
   19   1          // MASTER   Start   SlaveAddr+W             RegisterAddr            Data0           Data1          ..
             -.  DataN          Stop
   20   1          // SLAVE                            ACK                     ACK             ACK             ACK      
             -       ...  ACK
   21   1          unsigned char i;
   22   1      
   23   1          IIC_START();                            // å‘é€èµ·å§‹ä¿¡å·
   24   1          IIC_SENDBYTE(slave_addr);               // å‘é€ä»è®¾å¤‡åœ°å€åŠ å†™æ“ä½œä½
   25   1          IIC_WAITACK();                          // ç­‰å¾…ä»è®¾å¤‡çš„åº”ç­”
   26   1          IIC_SENDBYTE(register_addr);            // å‘é€å¯„å­˜å™¨åœ°å€
   27   1          IIC_WAITACK();                          // ç­‰å¾…ä»è®¾å¤‡çš„åº”ç­”
   28   1      
   29   1          for(i = 0; i < bytes_to_send; i++)      // å¯¹äºæ‰€æœ‰è¦å‘é€çš„æ•°æ®
   30   1          {
   31   2              IIC_SENDBYTE(dat_to_send[i]);       // å‘é€æ•°æ®
   32   2              IIC_WAITACK();                      // ç­‰å¾…ä»è®¾å¤‡çš„åº”ç­”
   33   2          }
   34   1      
   35   1          IIC_STOP();                             // å‘é€åœæ­¢ä¿¡å·
   36   1      }
   37          
   38          void LSM303_MasterRecieveOneBytefromSlave(unsigned char slave_addr, unsigned char register_addr, unsigned
             - char dat_storage) 
   39          {
   40   1          // MASTER   Start   SlaveAddr+W             RegisterAddr            StartRepeat     SlaveAddr+R      
             -               NACK    Stop
   41   1          // SLAVE                            ACK                     ACK                                     A
             -CK     Data
   42   1          IIC_START();
   43   1          IIC_SENDBYTE(slave_addr+0);
   44   1          IIC_WAITACK();
   45   1          IIC_SENDBYTE(register_addr);
   46   1          IIC_WAITACK();
   47   1          IIC_START();
   48   1          IIC_SENDBYTE(slave_addr+1);
*** WARNING C188 IN LINE 48 OF Externals\lsm303.c: 'parameter 1': value truncated
   49   1          IIC_WAITACK();
   50   1          dat_storage = IIC_READBYTE();
C251 COMPILER V5.60.0,  lsm303                                                             06/04/24  15:24:48  PAGE 2   

   51   1          IIC_SENDNACK();
   52   1          IIC_STOP();
   53   1      }
   54          
   55          void LSM303_MasterReceiveMultipleBytesfromSlave(unsigned char slave_addr, unsigned char register_addr, un
             -signed char *data_buffer, unsigned char bytes_to_receive)
   56          {
   57   1          // MASTER   Start   SlaveAddr+W             RegisterAddr            StartRepeat     SlaveAddr+R      
             -               ACK             ACK     ...     NACK    Stop
   58   1          // SLAVE                            ACK                     ACK                                     A
             -CK     Data1           DataN           ...
   59   1          unsigned char i;
   60   1      
   61   1          IIC_START();                            // å‘é€èµ·å§‹ä¿¡å·
   62   1          IIC_SENDBYTE(slave_addr);               // å‘é€ä»è®¾å¤‡åœ°å€åŠ å†™æ“ä½œä½
   63   1          IIC_WAITACK();                          // ç­‰å¾…ä»è®¾å¤‡çš„åº”ç­”
   64   1          IIC_SENDBYTE(register_addr);            // å‘é€å¯„å­˜å™¨åœ°å€
   65   1          IIC_WAITACK();                          // ç­‰å¾…ä»è®¾å¤‡çš„åº”ç­”
   66   1      
   67   1          IIC_START();                            // å‘é€é‡å¤èµ·å§‹ä¿¡å·ï¼Œåˆ‡æ¢åˆ°è¯»æ¨¡å¼
   68   1          IIC_SENDBYTE(slave_addr + 1);           // å‘é€ä»è®¾å¤‡åœ°å€åŠ è¯»æ“ä½œä½
*** WARNING C188 IN LINE 68 OF Externals\lsm303.c: 'parameter 1': value truncated
   69   1          IIC_WAITACK();                          // ç­‰å¾…ä»è®¾å¤‡çš„åº”ç­”
   70   1      
   71   1          for(i = 0; i < bytes_to_receive - 1; i++) // å¯¹äºæ‰€æœ‰è¦æ¥æ”¶çš„æ•°æ®ï¼ˆæœ€åä¸€ä¸ªå­—èŠ‚é™¤å¤
             -–ï¼‰
   72   1          {
   73   2              data_buffer[i] = IIC_READBYTE();    // è¯»å–æ•°æ®
   74   2              IIC_SENDACK();                      // å‘é€åº”ç­”ä¿¡å·ï¼Œå‡†å¤‡æ¥æ”¶ä¸‹ä¸€ä¸ªå­—èŠ‚
   75   2          }
   76   1          
   77   1          // è¯»å–æœ€åä¸€ä¸ªå­—èŠ‚å¹¶å‘é€éåº”ç­”ä¿¡å·
   78   1          data_buffer[bytes_to_receive - 1] = IIC_READBYTE(); // è¯»å–æœ€åä¸€ä¸ªå­—èŠ‚çš„æ•°æ®
   79   1          IIC_SENDNACK();                         // å¯¹äºæœ€åä¸€ä¸ªå­—èŠ‚ï¼Œå‘é€éåº”ç­”ä¿¡å·
   80   1          IIC_STOP();                             // å‘é€åœæ­¢ä¿¡å·
   81   1      }
   82          
   83          void LSM303_Init(void) 
   84          {
   85   1          LSM303_Acc_Init();
   86   1          LSM303_Mag_Init();
   87   1      }
   88          
   89          void LSM303_Acc_Init(void) 
   90          {
   91   1          // åˆå§‹åŒ–åŠ é€Ÿåº¦ä¼ æ„Ÿå™¨
   92   1          // å†™å…¥LSM303_CTRL_REG[1:6]_Aå¯„å­˜å™¨
   93   1      
   94   1          unsigned char CTRL_REG1;
   95   1          unsigned char CTRL_REG2;
   96   1          unsigned char CTRL_REG3;
   97   1          unsigned char CTRL_REG4;
   98   1          unsigned char CTRL_REG5;
   99   1          unsigned char CTRL_REG6;
  100   1      
  101   1          CTRL_REG1 = 0x57;
  102   1          // é…ç½®ä¸º 0101 0111 = 0x57
  103   1          // å‰å››ä½ï¼š 0000 å…³æœºæ¨¡å¼
  104   1          //          0011 é€šç”¨1Hz    0010 é€šç”¨10Hz   0011 é€šç”¨25Hz   0100 é€šç”¨50Hz   0101 é€šç”¨100Hz
  105   1          //          0110 é€šç”¨200Hz  0111 é€šç”¨400Hz  1000 ä½åŠŸè€—1.620kHz             1001 æ™®é€š1.344kH
             -z/ä½åŠŸè€—5.376kHz
  106   1          // åå››ä½ï¼š *___ 0:ä½åŠŸè€—æ¨¡å¼å…³é—­   /   1:ä½åŠŸè€—æ¨¡å¼å¼€å¯
  107   1          //          _*__ 0:Zè½´å…³é—­          /   1:Zè½´å¼€å¯
  108   1          //          __*_ 0:Yè½´å…³é—­          /   1:Yè½´å¼€å¯
  109   1          //          ___* 0:Xè½´å…³é—­          /   1:Xè½´å¼€å¯
  110   1      
C251 COMPILER V5.60.0,  lsm303                                                             06/04/24  15:24:48  PAGE 3   

  111   1          CTRL_REG2 = 0x00; // é«˜é€šæ»¤æ³¢å™¨é…ç½®å…³é—­
  112   1          CTRL_REG3 = 0x00; // æ‰€æœ‰ä¸­æ–­å…³é—­
  113   1          CTRL_REG4 = 0x00; // æ•°æ®è¾“å‡ºæ ¼å¼è®¾ç½®ä¸ºæ­£å¸¸æ¨¡å¼ï¼ŒÂ±2g
  114   1          CTRL_REG5 = 0x00; // FIFOå…³é—­ï¼Œä¸ä½¿ç”¨é«˜é€šæ»¤æ³¢å™¨
  115   1          CTRL_REG6 = 0x00; // ä¸­æ–­æ´»åŠ¨é…ç½®å…³é—­
  116   1      
  117   1          // å†™å…¥å¯„å­˜å™¨
  118   1          LSM303_MasterWriteOneBytetoSlave(LSM303_ACC_ADDRESS, LSM303_CTRL_REG1_A, CTRL_REG1);
  119   1          LSM303_MasterWriteOneBytetoSlave(LSM303_ACC_ADDRESS, LSM303_CTRL_REG2_A, CTRL_REG2);
  120   1          LSM303_MasterWriteOneBytetoSlave(LSM303_ACC_ADDRESS, LSM303_CTRL_REG3_A, CTRL_REG3);
  121   1          LSM303_MasterWriteOneBytetoSlave(LSM303_ACC_ADDRESS, LSM303_CTRL_REG4_A, CTRL_REG4);
  122   1          LSM303_MasterWriteOneBytetoSlave(LSM303_ACC_ADDRESS, LSM303_CTRL_REG5_A, CTRL_REG5);
  123   1          LSM303_MasterWriteOneBytetoSlave(LSM303_ACC_ADDRESS, LSM303_CTRL_REG6_A, CTRL_REG6);
  124   1      }
  125          
  126          void LSM303_Mag_Init(void) {
  127   1          // åˆå§‹åŒ–ç£åœºä¼ æ„Ÿå™¨
  128   1          unsigned char data_temp;
  129   1      
  130   1          // é…ç½®CRA_REG_Mï¼Œæ•°æ®è¾“å‡ºé€Ÿç‡ä¸º15Hz
  131   1          data_temp = 0x10; // 0001 0000
  132   1          LSM303_MasterWriteOneBytetoSlave(LSM303_MAG_ADDRESS, LSM303_CRA_REG_M, data_temp);
  133   1      
  134   1          // é…ç½®CRB_REG_Mï¼Œå¢ç›Šé…ç½®ä¸ºÂ±1.3Gauss
  135   1          data_temp = 0x20; // 0010 0000
  136   1          LSM303_MasterWriteOneBytetoSlave(LSM303_MAG_ADDRESS, LSM303_CRB_REG_M, data_temp);
  137   1      
  138   1          // é…ç½®MR_REG_Mï¼Œè®¾ç½®ä¸ºè¿ç»­è½¬æ¢æ¨¡å¼
  139   1          data_temp = 0x00; // 0000 0000
  140   1          LSM303_MasterWriteOneBytetoSlave(LSM303_MAG_ADDRESS, LSM303_MR_REG_M, data_temp);
  141   1      }
  142          
  143          float LSM303_Read_Acc(char axis) 
  144          {
  145   1          unsigned char acc_data[2];
  146   1          float acc_value;
  147   1          unsigned char addr;
  148   1      
  149   1          // æ ¹æ®è½´é€‰æ‹©æ­£ç¡®çš„å¯„å­˜å™¨åœ°å€
  150   1          switch(axis) {
  151   2              case 'x':
  152   2                  addr = LSM303_OUT_X_L_A;
  153   2                  break;
  154   2              case 'y':
  155   2                  addr = LSM303_OUT_Y_L_A;
  156   2                  break;
  157   2              case 'z':
  158   2                  addr = LSM303_OUT_Z_L_A;
  159   2                  break;
  160   2              default:
  161   2                  return 0; // å¦‚æœè½´ä¸æ­£ç¡®ï¼Œåˆ™è¿”å›0
  162   2          }
  163   1      
  164   1          // è¯»å–åŠ é€Ÿåº¦è®¡çš„æ•°æ®
  165   1          LSM303_MasterReceiveMultipleBytesfromSlave(LSM303_ACC_ADDRESS, addr, acc_data, 2);
  166   1      
  167   1          // è®¡ç®—åŠ é€Ÿåº¦å€¼ï¼Œè€ƒè™‘åˆ°æ•°æ®ä¸º16ä½ï¼Œå·¦ç§»é«˜ä½å¹¶åŠ ä¸Šä½ä½
  168   1          acc_value = ((short)(acc_data[1] << 8 | acc_data[0])) / 16384.0f;
  169   1      
  170   1          return acc_value;
  171   1      }
  172          
  173          float LSM303_Read_Mag(char axis) 
  174          {
  175   1          unsigned char mag_data[2];
  176   1          float mag_value;
C251 COMPILER V5.60.0,  lsm303                                                             06/04/24  15:24:48  PAGE 4   

  177   1          unsigned char addr;
  178   1      
  179   1          // æ ¹æ®è½´é€‰æ‹©æ­£ç¡®çš„å¯„å­˜å™¨åœ°å€
  180   1          switch(axis) {
  181   2              case 'x':
  182   2                  addr = LSM303_OUT_X_H_M;
  183   2                  break;
  184   2              case 'y':
  185   2                  addr = LSM303_OUT_Y_H_M;
  186   2                  break;
  187   2              case 'z':
  188   2                  addr = LSM303_OUT_Z_H_M;
  189   2                  break;
  190   2              default:
  191   2                  return 0; // å¦‚æœè½´ä¸æ­£ç¡®ï¼Œåˆ™è¿”å›0
  192   2          }
  193   1      
  194   1          // è¯»å–ç£åœºè®¡çš„æ•°æ®
  195   1          LSM303_MasterReceiveMultipleBytesfromSlave(LSM303_MAG_ADDRESS, addr, mag_data, 2);
  196   1      
  197   1          // è®¡ç®—ç£åœºå€¼ï¼Œç”±äºç£åœºä¼ æ„Ÿå™¨çš„æ•°æ®æ’åˆ—ä¸åŠ é€Ÿåº¦è®¡ä¸åŒï¼Œéœ€è¦å…ˆè¯»é«˜ä½
  198   1          mag_value = ((short)(mag_data[0] << 8 | mag_data[1])) / 1100.0f;
  199   1      
  200   1          return mag_value;
  201   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       567     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------         12
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  2 WARNING(S),  0 ERROR(S)
